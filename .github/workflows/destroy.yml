name: Destroy

on:
  workflow_call:
    inputs:
      confirm:
        type: string
        required: true
        description: Type "DESTROY" to confirm destruction
      cloud_provider:
        type: string
        default: digitalocean
      stack_name:
        type: string
        default: ''
      region:
        type: string
        default: ''
      state_bucket:
        type: string
        default: staxless-terraform-state
      state_key:
        type: string
        default: ''
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      MANAGER_IP:
        required: true
      DIGITALOCEAN_TOKEN:
        required: true
      DO_SPACES_ACCESS_KEY:
        required: true
      DO_SPACES_SECRET_KEY:
        required: true
      SSH_FINGERPRINT:
        required: true
      DOMAIN:
        required: true

jobs:
  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Confirm destruction
        run: |
          if [ "${{ inputs.confirm }}" != "DESTROY" ]; then
            echo "Must type DESTROY to confirm"
            exit 1
          fi

      - name: Checkout consumer repo
        uses: actions/checkout@v4

      - name: Checkout staxless-deploy
        uses: actions/checkout@v4
        with:
          repository: staxless/staxless-deploy
          path: .staxless-deploy

      - name: Resolve Config
        id: config
        uses: ./.staxless-deploy/actions/resolve-config
        with:
          stack_name: ${{ inputs.stack_name }}
          region: ${{ inputs.region }}

      - name: Setup SSH
        uses: ./.staxless-deploy/actions/setup-ssh
        with:
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup Tools
        uses: ./.staxless-deploy/actions/setup-tools
        with:
          do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          cloud_provider: ${{ inputs.cloud_provider }}

      - name: Whitelist SSH
        uses: ./.staxless-deploy/actions/whitelist-ssh
        with:
          do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          stack_name: ${{ steps.config.outputs.stack_name }}

      - name: Graceful Shutdown
        uses: ./.staxless-deploy/actions/graceful-shutdown
        with:
          manager_ip: ${{ secrets.MANAGER_IP }}
          stack_name: ${{ steps.config.outputs.stack_name }}
        continue-on-error: true

      - name: Destroy Infrastructure
        uses: ./.staxless-deploy/actions/terraform-destroy
        with:
          cloud_provider: ${{ inputs.cloud_provider }}
          do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          do_spaces_access_key: ${{ secrets.DO_SPACES_ACCESS_KEY }}
          do_spaces_secret_key: ${{ secrets.DO_SPACES_SECRET_KEY }}
          ssh_fingerprint: ${{ secrets.SSH_FINGERPRINT }}
          domain: ${{ secrets.DOMAIN }}
          stack_name: ${{ steps.config.outputs.stack_name }}
          region: ${{ steps.config.outputs.region }}
          state_bucket: ${{ inputs.state_bucket }}
          state_key: ${{ inputs.state_key || format('{0}/terraform.tfstate', steps.config.outputs.stack_name) }}

      - name: Remove SSH Whitelist
        if: always()
        uses: ./.staxless-deploy/actions/remove-ssh
        with:
          do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          stack_name: ${{ steps.config.outputs.stack_name }}

      - name: Summary
        run: |
          echo "DigitalOcean infrastructure destroyed"
          echo "MongoDB Atlas preserved"
          echo "Delete manually: https://cloud.mongodb.com"
