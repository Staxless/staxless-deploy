name: Whitelist SSH
description: Open SSH for the current GitHub Actions runner IP on the DigitalOcean firewall

inputs:
  do_token:
    description: DigitalOcean API token
    required: true
  stack_name:
    description: Stack name to locate the firewall
    required: true

runs:
  using: composite
  steps:
    - name: Open SSH for runner IP
      timeout-minutes: 10
      shell: bash
      env:
        DO_TOKEN: ${{ inputs.do_token }}
      run: |
        set -euo pipefail

        if [ -z "$DO_TOKEN" ]; then
          echo "::warning::No DigitalOcean token provided, skipping SSH whitelist"
          exit 0
        fi

        STACK="${{ inputs.stack_name }}"
        API="https://api.digitalocean.com/v2"
        AUTH="Authorization: Bearer $DO_TOKEN"

        # Get firewall ID by name
        FIREWALLS=$(curl -sf "$API/firewalls?per_page=200" -H "$AUTH")
        FW_ID=$(echo "$FIREWALLS" | jq -r --arg name "${STACK}-firewall" '.firewalls[] | select(.name == $name) | .id')

        if [ -z "$FW_ID" ]; then
          echo "::error::Firewall ${STACK}-firewall not found"
          exit 1
        fi
        echo "Firewall ID: $FW_ID"

        # Get runner IP and current firewall config in parallel
        curl -sf https://api.ipify.org > /tmp/runner_ip.txt &
        IP​​​​​​​​​​​​​​​​

